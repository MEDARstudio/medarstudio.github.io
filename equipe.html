<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sélection Équipe - Fantasy Botola Pro Inwi 2025/2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        :root {
            --primary: #6A0DAD; /* Violet foncé */
            --secondary: #9370DB; /* Violet moyen */
            --accent: #BA55D3; /* Violet orchidée */
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --dark-bg: #1a0033;
            --card-bg: rgba(106, 13, 173, 0.1);
            --hover-bg: rgba(186, 85, 211, 0.15);
            --success: #4CAF50;
            --warning: #FFC107;
            --danger: #F44336;
            --field-green: #1e7e34;
        }
        body {
            background: linear-gradient(135deg, var(--dark-bg) 0%, #2d0052 100%);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }
        /* En-tête */
        header {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 1rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logo-icon {
            background: var(--primary);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        .logo-text {
            font-size: 1.8rem;
            font-weight: 700;
        }
        .logo-text span {
            color: var(--accent);
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent);
        }
        .budget-display {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            background: var(--card-bg);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            border: 1px solid var(--accent);
        }
        .budget-amount {
            color: var(--accent);
            font-weight: 600;
        }
        .logout-btn {
            background: none;
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            margin-left: 10px;
        }
        .logout-btn:hover {
            background: var(--accent);
            color: var(--dark);
        }
        /* Contenu principal */
        .main-container {
            display: flex;
            max-width: 1800px;
            margin: 2rem auto;
            padding: 0 2rem;
            gap: 2rem;
        }
        .pitch-section {
            flex: 2;
            min-width: 0;
        }
        .page-title {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 2rem;
            color: var(--accent);
        }
        /* Navigation de la formation */
        .formation-nav {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        .formation-option {
            background: var(--card-bg);
            color: var(--light);
            border: 1px solid rgba(186, 85, 211, 0.3);
            padding: 0.7rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .formation-option:hover, .formation-option.active {
            background: var(--accent);
            border-color: var(--accent);
        }
        /* Terrain */
        .pitch-container {
            background: linear-gradient(to bottom, var(--field-green) 0%, var(--field-green) 50%, #3cb371 50%, #3cb371 100%);
            border: 3px solid white;
            border-radius: 10px;
            position: relative;
            min-height: 600px;
            margin-bottom: 2rem;
            overflow: hidden;
        }
        .pitch-line {
            position: absolute;
            background: white;
        }
        .center-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            border: 2px solid white;
            border-radius: 50%;
        }
        .center-spot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 5px;
            height: 5px;
            background: white;
            border-radius: 50%;
        }
        .penalty-area {
            position: absolute;
            border: 2px solid white;
        }
        .goal-area {
            position: absolute;
            border: 2px solid white;
        }
        .penalty-spot {
            position: absolute;
            width: 5px;
            height: 5px;
            background: white;
            border-radius: 50%;
        }
        .corner-arc {
            position: absolute;
            border: 2px solid white;
            border-radius: 50%;
        }
        /* Positions */
        .positions-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-rows: repeat(5, 1fr);
            padding: 2%;
        }
        .position-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .position {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px dashed rgba(255, 255, 255, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 10;
        }
        .position:hover {
            background: rgba(186, 85, 211, 0.3);
            border-style: solid;
        }
        .position.occupied {
            background: rgba(106, 13, 173, 0.7);
            border: 2px solid var(--accent);
        }
        .position-icon {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        .position-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-align: center;
        }
        /* Résumé de l'équipe */
        .team-summary {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(186, 85, 211, 0.3);
        }
        .summary-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        .stat-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 1.2rem;
            text-align: center;
            border: 1px solid rgba(186, 85, 211, 0.2);
        }
        .stat-label {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: #d0d0d0;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
        }
        .stat-value.positive {
            color: var(--success);
        }
        .stat-value.warning {
            color: var(--warning);
        }
        .stat-value.danger {
            color: var(--danger);
        }
        /* Zone de sélection des joueurs */
        .players-section {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 2rem;
            border: 1px solid rgba(186, 85, 211, 0.2);
            display: flex;
            flex-direction: column;
        }
        .section-title {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .search-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 0.8rem;
            border-radius: 8px;
            border: 1px solid rgba(186, 85, 211, 0.3);
            background: rgba(0, 0, 0, 0.3);
            color: var(--light);
            font-size: 1rem;
        }
        .filter-select {
            padding: 0.8rem;
            border-radius: 8px;
            border: 1px solid rgba(186, 85, 211, 0.3);
            background: rgba(0, 0, 0, 0.3);
            color: var(--light);
            font-size: 1rem;
        }
        .players-list {
            flex: 1;
            overflow-y: auto;
            max-height: 500px; /* Augmente légèrement la hauteur de la liste */
        }
        .players-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        .player-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border: 1px solid rgba(186, 85, 211, 0.2);
            transition: all 0.3s ease;
             /* Alignement vertical sur mobile */
            flex-direction: column;
            align-items: flex-start;
        }
        .player-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border-color: var(--accent);
        }
        .player-avatar {
            width: 45px; /* Réduit la taille de l'avatar */
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
             /* Réduction de la taille sur mobile */
            width: 40px;
            height: 40px;
        }
        .player-info {
            flex: 1;
        }
        .player-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.2rem;
        }
        .player-club-position {
            font-size: 0.9rem;
            color: #d0d0d0;
            margin-bottom: 0.5rem;
        }
        .player-stats {
            display: flex;
            gap: 1rem;
            margin: 0.5rem 0;
        }
        .stat {
            text-align: center;
        }
        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent);
        }
        .stat-label {
            font-size: 0.8rem;
            color: #c0c0c0;
        }
        /* - Modification ici : Footer du joueur avec décalage - */
        .player-footer {
            display: flex;
            flex-direction: column; /* Passe en colonne */
            align-items: flex-end; /* Alignement à droite */
            gap: 0.6rem; /* Espacement entre le prix et le bouton */
            margin-left: 1rem; /* Espacement par rapport aux autres éléments */
            flex-shrink: 0; /* Empêche la réduction */
        }
        .player-price {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent);
        }
        .select-player-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap; /* Empêche le retour à la ligne */
        }
        .select-player-btn:hover {
            background: var(--secondary);
        }
        .select-player-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
        }
        /* - Fin de la modification - */
        /* Bouton de suppression */
        .remove-player-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        .remove-player-btn:hover {
            background: #d32f2f;
        }
        /* Emplacements des remplaçants */
        .substitutes-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 1rem;
            border: 1px solid rgba(186, 85, 211, 0.2);
        }
        .substitutes-title {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .substitutes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }
        .substitute-slot {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(186, 85, 211, 0.5);
            border-radius: 10px;
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .substitute-slot:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }
        .substitute-slot.occupied {
            background: rgba(106, 13, 173, 0.7);
            border: 2px solid var(--accent);
        }
        .substitute-icon {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        /* Bouton de validation */
        .validation-section {
            text-align: right;
            margin-top: 2rem;
        }
        .validate-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1.2rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(106, 13, 173, 0.4);
        }
        .validate-button:hover {
            background: var(--accent);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(186, 85, 211, 0.6);
        }
        /* Responsive */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            .pitch-section, .players-section {
                flex: 1;
            }
        }
        @media (max-width: 992px) {
            .positions-container {
                grid-template-rows: repeat(6, 1fr);
            }
            .position {
                width: 50px;
                height: 50px;
                 /* - CORRECTION ICI : Empêcher la réduction des postes - */
                flex-shrink: 0; /* Empêche la réduction des postes */
                /* - FIN DE LA CORRECTION - */
            }
            .position-icon {
                font-size: 1rem;
            }
            .position-label {
                font-size: 0.7rem;
            }
            /* - SUPPRESSION DE CETTE LIGNE ERRONEE - */
            /* .position-row { margin: 5px 0; } */ /* Cette ligne causait le problème */
            /* - FIN DE LA SUPPRESSION - */
            .players-list {
                max-height: 500px; /* Augmente légèrement la hauteur de la liste */
            }
            .player-card {
                padding: 0.8rem; /* Réduit le padding */
                /* Alignement vertical sur mobile */
                flex-direction: column;
                align-items: flex-start;
            }
            .player-avatar {
                width: 45px; /* Réduit la taille de l'avatar */
                height: 45px;
                 /* Réduction de la taille sur mobile */
                width: 40px;
                height: 40px;
            }
            .player-info {
                margin: 0.5rem 0;
            }
            .player-stats {
                gap: 0.8rem;
            }
            .stat-value {
                font-size: 1rem;
            }
            .player-footer {
                margin-top: 0.5rem;
                align-items: flex-start; /* Alignement à gauche sur mobile */
            }
            .player-price {
                font-size: 1rem;
            }
            .select-player-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.9rem;
            }
        }
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            .user-info {
                flex-direction: column;
                gap: 10px;
            }
            .main-container {
                padding: 0 1rem;
            }
            .page-title {
                font-size: 2rem;
            }
            .formation-nav {
                gap: 0.5rem;
            }
            .formation-option {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
            .pitch-container {
                min-height: 500px;
            }
            .positions-container {
                grid-template-rows: repeat(7, 1fr);
            }
            .position {
                width: 45px;
                height: 45px;
                 /* - CORRECTION ICI : Empêcher la réduction des postes - */
                flex-shrink: 0; /* Empêche la réduction des postes */
                /* - FIN DE LA CORRECTION - */
            }
            .position-label {
                font-size: 0.6rem;
            }
            .summary-stats {
                grid-template-columns: 1fr;
            }
            .search-filters {
                flex-direction: column;
            }
            .search-box, .filter-select {
                width: 100%;
            }
        }
        @media (max-width: 480px) {
            .page-title {
                font-size: 1.8rem;
            }
            .formation-option {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
            .position {
                width: 40px;
                height: 40px;
                 /* - CORRECTION ICI : Empêcher la réduction des postes - */
                flex-shrink: 0; /* Empêche la réduction des postes */
                /* - FIN DE LA CORRECTION - */
            }
            .position-label {
                font-size: 0.5rem;
            }
            .stat-card {
                padding: 1rem;
            }
            .stat-value {
                font-size: 1.5rem;
            }
            .substitutes-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- En-tête -->
    <header>
        <div class="logo">
            <div class="logo-icon">
                <i class="fas fa-futbol"></i>
            </div>
            <div class="logo-text">Fantasy <span>Botola Pro</span> Inwi</div>
        </div>
        <div class="user-info">
            <div class="user-profile">
                <img id="userAvatar" src="https://via.placeholder.com/40" alt="Utilisateur" class="user-avatar">
                <span id="userName">Utilisateur</span>
            </div>
            <div class="budget-display">
                <i class="fas fa-coins"></i>
                <span>Budget: </span>
                <span class="budget-amount" id="budgetAmount">100.0M MAD</span>
            </div>
            <button class="logout-btn" id="logoutBtn">Déconnexion</button>
        </div>
    </header>

    <!-- Contenu principal -->
    <div class="main-container">
        <div class="pitch-section">
            <h1 class="page-title">Sélection de votre Équipe</h1>

            <!-- Navigation de la formation -->
            <div class="formation-nav">
                <div class="formation-option active" data-formation="3-4-3">3-4-3</div>
                <div class="formation-option" data-formation="3-5-2">3-5-2</div>
                <div class="formation-option" data-formation="4-4-2">4-4-2</div>
                <div class="formation-option" data-formation="4-3-3">4-3-3</div>
                <div class="formation-option" data-formation="5-3-2">5-3-2</div>
            </div>

            <!-- Terrain -->
            <div class="pitch-container">
                <!-- Lignes du terrain -->
                <div class="pitch-line" style="width: 100%; height: 2px; top: 50%;"></div>
                <div class="pitch-line" style="height: 100%; width: 2px; left: 50%;"></div>
                <div class="center-circle"></div>
                <div class="center-spot"></div>
                
                <!-- Zones de penalty et but -->
                <div class="penalty-area" style="width: 20%; height: 30%; top: 0; left: 40%; border-right: none; border-bottom: none;"></div>
                <div class="penalty-area" style="width: 20%; height: 30%; bottom: 0; left: 40%; border-right: none; border-top: none;"></div>
                <div class="goal-area" style="width: 10%; height: 15%; top: 0; left: 45%; border-right: none; border-bottom: none;"></div>
                <div class="goal-area" style="width: 10%; height: 15%; bottom: 0; left: 45%; border-right: none; border-top: none;"></div>
                
                <!-- Points de penalty -->
                <div class="penalty-spot" style="top: 15%; left: 50%;"></div>
                <div class="penalty-spot" style="bottom: 15%; left: 50%;"></div>
                
                <!-- Arcs de corner -->
                <div class="corner-arc" style="width: 30px; height: 30px; top: 0; left: 0; border-top: none; border-left: none;"></div>
                <div class="corner-arc" style="width: 30px; height: 30px; top: 0; right: 0; border-top: none; border-right: none;"></div>
                <div class="corner-arc" style="width: 30px; height: 30px; bottom: 0; left: 0; border-bottom: none; border-left: none;"></div>
                <div class="corner-arc" style="width: 30px; height: 30px; bottom: 0; right: 0; border-bottom: none; border-right: none;"></div>
                
                <!-- Conteneur des positions -->
                <div class="positions-container" id="positionsContainer">
                    <!-- Les positions seront générées par JavaScript -->
                </div>
            </div>

            <!-- Résumé de l'équipe -->
            <div class="team-summary">
                <h3 class="summary-title"><i class="fas fa-info-circle"></i> Résumé de votre Équipe</h3>
                <div class="summary-stats">
                    <div class="stat-card">
                        <div class="stat-label">Joueurs sélectionnés</div>
                        <div class="stat-value" id="playersCount">0/15</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Budget restant</div>
                        <div class="stat-value" id="remainingBudget">100.0M MAD</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Moyenne âge</div>
                        <div class="stat-value" id="averageAge">0.0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Clubs différents</div>
                        <div class="stat-value" id="clubsCount">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Zone de sélection des joueurs -->
        <div class="players-section">
            <h3 class="section-title"><i class="fas fa-users"></i> Liste des Joueurs</h3>
            <div class="search-filters">
                <input type="text" class="search-box" id="searchBox" placeholder="Rechercher un joueur...">
                <select class="filter-select" id="positionFilter">
                    <option value="">Toutes positions</option>
                    <option value="GK">Gardien (GK)</option>
                    <option value="DEF">Défenseur (DEF)</option>
                    <option value="MID">Milieu (MID)</option>
                    <option value="ATT">Attaquant (ATT)</option>
                </select>
                <select class="filter-select" id="clubFilter">
                    <option value="">Tous les clubs</option>
                    <!-- Les options de club seront générées par JavaScript -->
                </select>
            </div>
            <div class="players-list">
                <div class="players-grid" id="playersGrid">
                    <!-- Les cartes de joueurs seront générées par JavaScript -->
                </div>
            </div>

            <!-- Emplacements des remplaçants -->
            <div class="substitutes-container">
                <h4 class="substitutes-title"><i class="fas fa-arrows-alt-h"></i> Remplaçants</h4>
                <div class="substitutes-grid" id="substitutesGrid">
                    <!-- Les emplacements de remplaçants seront générés par JavaScript -->
                </div>
            </div>

            <!-- Bouton de validation -->
            <div class="validation-section">
                <button class="validate-button" id="validateTeamBtn">
                    <i class="fas fa-check-circle"></i> Valider l'Équipe
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Nouveau : Vérifier la connexion au chargement de la page ---
        let currentUser = null; // Variable pour stocker les infos de l'utilisateur connecté

        window.onload = function() {
            const savedUser = localStorage.getItem('fantasyUser');
            if (!savedUser) {
                // Si aucun utilisateur n'est connecté, rediriger vers la page d'accueil
                alert("Vous devez être connecté pour accéder à cette page.");
                window.location.href = 'index.html';
                return; // Arrêter l'exécution du script
            }

            try {
                currentUser = JSON.parse(savedUser); // Stocker les infos de l'utilisateur
                // Afficher les informations de l'utilisateur dans l'en-tête
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userAvatar').src = currentUser.picture;
                console.log("Utilisateur connecté sur cette page:", currentUser.name);
                // Vous pouvez ici initialiser d'autres parties de la page
                // Par exemple, charger les données de l'équipe sauvegardée
                // loadSavedTeamData(currentUser.sub); // currentUser.sub est l'ID unique Google
            } catch (e) {
                console.error("Erreur lors de la récupération des données utilisateur:", e);
                localStorage.removeItem('fantasyUser');
                window.location.href = 'index.html';
            }
        };

        // --- Nouveau : Fonction de déconnexion pour cette page ---
        document.addEventListener('DOMContentLoaded', function() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    // Supprimer les données utilisateur du localStorage
                    localStorage.removeItem('fantasyUser');
                    // --- Nouveau : Supprimer les données de l'équipe de localStorage (si vous les stockez ici) ---
                    // localStorage.removeItem('fantasyTeamData'); // Décommentez si vous sauvegardez l'équipe ici
                    alert('Vous avez été déconnecté avec succès.');
                    // Rediriger vers la page d'accueil
                    window.location.href = 'index.html';
                });
            }
        });

        // Variables globales
        let playersData = []; // Données des joueurs chargées depuis le CSV
        let currentFormation = "3-4-3";
        let selectedPlayers = []; // Tableau pour stocker les joueurs sélectionnés avec leur index
        const budget = 100.0;
        let remainingBudget = budget;
        let currentPosition = null; // Position actuellement sélectionnée sur le terrain
        let currentSubstitute = null; // Emplacement de remplaçant actuellement sélectionné
        let currentTargetPosition = null; // Type de position cible (GK, DEF, MID, ATT)

        // Chargement des données depuis le CSV
        document.addEventListener('DOMContentLoaded', function() {
            fetch('players.csv')
                .then(response => response.text())
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        // - MODIFICATION ICI : Convertir les valeurs numériques -
                        // Papa Parse lit tout en tant que chaîne par défaut, il faut convertir prix, points, performance
                        transform: function(value, header) {
                            if (header === 'price' || header === 'points' || header === 'performance' || header === 'id') {
                                return parseFloat(value) || 0; // Convertit en nombre flottant, met 0 si échec
                            }
                            return value; // Laisse les autres valeurs telles quelles
                        }
                        // - FIN DE LA MODIFICATION -
                    }).then(results => {
                        if (results.errors.length > 0) {
                            console.error('Erreurs lors du parsing CSV:', results.errors);
                        }
                        playersData = results.data;
                        console.log('Données des joueurs chargées:', playersData);
                        
                        // Initialiser les filtres de club
                        populateClubFilter();
                        
                        // Afficher tous les joueurs
                        renderPlayers(playersData);
                        
                        // Initialiser la page (formation, etc.)
                        initializePage();
                    }).catch(error => {
                        console.error('Erreur lors du parsing CSV:', error);
                        // Afficher un message d'erreur à l'utilisateur
                        document.getElementById('playersGrid').innerHTML = '<p>Erreur lors du chargement des données des joueurs.</p>';
                    });
                })
                .catch(error => {
                    console.error('Erreur lors du chargement du fichier CSV:', error);
                    // Afficher un message d'erreur à l'utilisateur
                    document.getElementById('playersGrid').innerHTML = '<p>Impossible de charger le fichier des joueurs (players.csv).</p>';
                });
        });

        // - MODIFICATION ICI : Nouvelle fonction d'initialisation -
        // Déplace les parties de DOMContentLoaded qui dépendent de playersData ici
        function initializePage() {
            // Gestion des formations
            document.querySelectorAll('.formation-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.formation-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    this.classList.add('active');
                    currentFormation = this.dataset.formation;
                    updateFormation();
                });
            });

            // Initialiser la formation
            updateFormation();

            // Ajouter les écouteurs d'événements pour les filtres
            document.getElementById('searchBox').addEventListener('input', filterPlayers);
            document.getElementById('positionFilter').addEventListener('change', filterPlayers);
            document.getElementById('clubFilter').addEventListener('change', filterPlayers);

            // Ajouter l'écouteur d'événement pour le bouton de validation
            document.getElementById('validateTeamBtn').addEventListener('click', validateTeam);

            // Initialiser les emplacements de remplaçants
            initializeSubstitutes();
        }
        // - FIN DE LA MODIFICATION -

        // Initialiser les emplacements de remplaçants
        function initializeSubstitutes() {
            const substitutesGrid = document.getElementById('substitutesGrid');
            substitutesGrid.innerHTML = '';
            for (let i = 0; i < 4; i++) {
                const substitute = document.createElement('div');
                substitute.className = 'substitute-slot';
                substitute.dataset.index = 11 + i; // Indices 11, 12, 13, 14
                substitute.innerHTML = `
                    <div class="substitute-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>Remplaçant ${i+1}</div>
                `;
                substitute.addEventListener('click', function() {
                    // Désélectionner la position sur le terrain
                    if (currentPosition) {
                        currentPosition.style.boxShadow = 'none';
                        currentPosition = null;
                        currentTargetPosition = null;
                    }
                    // Gérer la sélection du remplaçant
                    document.querySelectorAll('.substitute-slot').forEach(slot => {
                        slot.style.boxShadow = 'none';
                    });
                    this.style.boxShadow = '0 0 0 3px var(--accent)';
                    currentSubstitute = this;
                    currentTargetPosition = null; // Pas de type spécifique pour les remplaçants
                });
                substitutesGrid.appendChild(substitute);
            }
        }

        // Remplir le filtre de club
        function populateClubFilter() {
            const clubFilter = document.getElementById('clubFilter');
            // Vider les options existantes sauf la première
            clubFilter.innerHTML = '<option value="">Tous les clubs</option>';
            const clubs = [...new Set(playersData.map(player => player.club))];
            clubs.forEach(club => {
                const option = document.createElement('option');
                option.value = club;
                option.textContent = club;
                clubFilter.appendChild(option);
            });
        }

        // Rendu des joueurs
        function renderPlayers(players) {
            const grid = document.getElementById('playersGrid');
            grid.innerHTML = '';
            
            if (players.length === 0) {
                grid.innerHTML = '<p>Aucun joueur trouvé.</p>';
                return;
            }

            players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                playerCard.dataset.playerId = player.id;
                
                // Vérifier si le joueur est déjà sélectionné
                const isSelected = selectedPlayers.some(p => p.player.id == player.id);
                const isDisabled = isSelected || remainingBudget < player.price;

                playerCard.innerHTML = `
                    <img src="${player.image || 'https://randomuser.me/api/portraits/men/' + (player.id % 100) + '.jpg'}" 
                         alt="${player.name}" class="player-avatar">
                    <div class="player-info">
                        <div class="player-name">${player.name}</div>
                        <div class="player-club-position">${player.club} - ${player.position}</div>
                        <div class="player-stats">
                            <div class="stat">
                                <div class="stat-value">${player.points || 0}</div>
                                <div class="stat-label">Points</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${player.performance || 0}</div>
                                <div class="stat-label">Perf</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${player.age || 0}</div>
                                <div class="stat-label">Ans</div>
                            </div>
                        </div>
                    </div>
                    <!-- - Modification ici : Footer du joueur avec décalage - -->
                    <div class="player-footer">
                        <div class="player-price">${player.price}M MAD</div>
                        <button class="select-player-btn" 
                                ${isDisabled ? 'disabled' : ''} 
                                data-player-id="${player.id}">
                            ${isSelected ? '<i class="fas fa-check"></i> Sélectionné' : '<i class="fas fa-plus"></i> Sélectionner'}
                        </button>
                    </div>
                    <!-- - Fin de la modification - -->
                `;
                grid.appendChild(playerCard);
            });
            
            // Ajouter les écouteurs d'événements aux boutons
            document.querySelectorAll('.select-player-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const playerId = this.dataset.playerId;
                    selectPlayer(playerId);
                });
            });
        }

        // Filtrer les joueurs
        function filterPlayers() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const positionFilter = document.getElementById('positionFilter').value;
            const clubFilter = document.getElementById('clubFilter').value;
            
            const filteredPlayers = playersData.filter(player => {
                const matchesSearch = player.name.toLowerCase().includes(searchTerm);
                const matchesPosition = positionFilter ? player.position === positionFilter : true;
                const matchesClub = clubFilter ? player.club === clubFilter : true;
                return matchesSearch && matchesPosition && matchesClub;
            });
            
            renderPlayers(filteredPlayers);
        }

        // Sélectionner un joueur
        function selectPlayer(playerId) {
            const player = playersData.find(p => p.id == playerId);
            if (!player) return;

            // Vérification du budget
            if (remainingBudget < player.price) {
                alert('Budget insuffisant pour ce joueur!');
                return;
            }

            // Vérification si le joueur est déjà sélectionné
            const existingPlayerIndex = selectedPlayers.findIndex(p => p.player.id == playerId);
            if (existingPlayerIndex !== -1) {
                alert('Ce joueur est déjà dans votre équipe!');
                return;
            }

            // Vérification de la limite de 4 joueurs par club
            const clubPlayers = selectedPlayers.filter(p => p.player.club === player.club);
            if (clubPlayers.length >= 4) {
                alert('Vous ne pouvez pas sélectionner plus de 4 joueurs du même club!');
                return;
            }

            // Vérifier s'il y a une position ou un emplacement de remplaçant sélectionné
            if (currentPosition) {
                // Ajouter le joueur à la position sélectionnée
                const positionIndex = selectedPlayers.length;
                selectedPlayers.push({ player, index: positionIndex });
                remainingBudget -= player.price;

                // Mettre à jour l'affichage de la position
                currentPosition.classList.add('occupied');
                currentPosition.innerHTML = `
                    <div class="position-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="position-label">${player.name.split(' ')[0]}</div>
                    <button class="remove-player-btn" onclick="removePlayer(${positionIndex})">Supprimer</button>
                `;
                currentPosition.style.boxShadow = 'none';

                // Réinitialiser la sélection
                currentPosition = null;
                currentTargetPosition = null;

            } else if (currentSubstitute) {
                // Ajouter le joueur à l'emplacement de remplaçant sélectionné
                const substituteIndex = parseInt(currentSubstitute.dataset.index);
                
                // Vérifier si l'emplacement est déjà occupé
                const existingSubIndex = selectedPlayers.findIndex(p => p.index === substituteIndex);
                if (existingSubIndex !== -1) {
                    alert('Cet emplacement de remplaçant est déjà occupé!');
                    return;
                }

                selectedPlayers.push({ player, index: substituteIndex });
                remainingBudget -= player.price;

                // Mettre à jour l'affichage du remplaçant
                currentSubstitute.classList.add('occupied');
                currentSubstitute.innerHTML = `
                    <div class="substitute-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>${player.name.split(' ')[0]}</div>
                    <button class="remove-player-btn" onclick="removePlayer(${substituteIndex})">Supprimer</button>
                `;
                currentSubstitute.style.boxShadow = 'none';

                // Réinitialiser la sélection
                currentSubstitute = null;
                currentTargetPosition = null;

            } else {
                // Si aucune position n'est sélectionnée, ajouter à la liste (comportement par défaut ?)
                // Pour l'instant, on demande de sélectionner une position
                alert('Veuillez d\'abord sélectionner une position sur le terrain ou un emplacement de remplaçant.');
                return;
            }

            // Mettre à jour l'interface
            updateSummary();
            filterPlayers(); // Re-filtrer pour désactiver le bouton du joueur ajouté
        }

        // Mise à jour de la formation
        function updateFormation() {
            // Vérifie si playersData est chargé
            if (playersData.length === 0) return;

            const [def, mid, att] = currentFormation.split('-').map(Number);
            
            // Effacer le conteneur
            const container = document.getElementById('positionsContainer');
            container.innerHTML = '';

            // Gardiens (toujours 1 en bas)
            const gkRow = document.createElement('div');
            gkRow.className = 'position-row';
            const gkPosition = document.createElement('div');
            gkPosition.className = 'position';
            gkPosition.dataset.position = 'GK';
            gkPosition.innerHTML = `
                <div class="position-icon">
                    <i class="fas fa-hand-paper"></i>
                </div>
                <div class="position-label">Gardien</div>
            `;
            gkPosition.addEventListener('click', function() {
                handlePositionClick(this, 'GK');
            });
            gkRow.appendChild(gkPosition);
            container.appendChild(gkRow);
            
            // Défenseurs
            const defRow = document.createElement('div');
            defRow.className = 'position-row';
            defRow.id = 'defense-row'; // Pour mise à jour dynamique si nécessaire
            for (let i = 0; i < def; i++) {
                const position = document.createElement('div');
                position.className = 'position';
                position.dataset.position = 'DEF';
                position.innerHTML = `
                    <div class="position-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="position-label">Défenseur</div>
                `;
                position.addEventListener('click', function() {
                    handlePositionClick(this, 'DEF');
                });
                defRow.appendChild(position);
            }
            container.appendChild(defRow);
            
            // Milieux
            const midRow = document.createElement('div');
            midRow.className = 'position-row';
            midRow.id = 'midfield-row'; // Pour mise à jour dynamique si nécessaire
            for (let i = 0; i < mid; i++) {
                const position = document.createElement('div');
                position.className = 'position';
                position.dataset.position = 'MID';
                position.innerHTML = `
                    <div class="position-icon">
                        <i class="fas fa-running"></i>
                    </div>
                    <div class="position-label">Milieu</div>
                `;
                position.addEventListener('click', function() {
                    handlePositionClick(this, 'MID');
                });
                midRow.appendChild(position);
            }
            container.appendChild(midRow);
            
            // Attaquants
            const attRow = document.createElement('div');
            attRow.className = 'position-row';
            attRow.id = 'attack-row'; // Pour mise à jour dynamique si nécessaire
            for (let i = 0; i < att; i++) {
                const position = document.createElement('div');
                position.className = 'position';
                position.dataset.position = 'ATT';
                position.innerHTML = `
                    <div class="position-icon">
                        <i class="fas fa-futbol"></i>
                    </div>
                    <div class="position-label">Attaquant</div>
                `;
                position.addEventListener('click', function() {
                    handlePositionClick(this, 'ATT');
                });
                attRow.appendChild(position);
            }
            container.appendChild(attRow);
        }

        // Gestion du clic sur une position
        function handlePositionClick(positionElement, positionType) {
            // Désélectionner l'emplacement de remplaçant
            if (currentSubstitute) {
                currentSubstitute.style.boxShadow = 'none';
                currentSubstitute = null;
            }
            
            // Gérer la sélection de la position
            document.querySelectorAll('.position').forEach(pos => {
                // Ne pas désélectionner la position actuelle ici, on la gère après
                if (pos !== positionElement) {
                    pos.style.boxShadow = 'none';
                }
            });
            
            // Vérifier si cette position est déjà occupée
            if (positionElement.classList.contains('occupied')) {
                // Vous pouvez choisir de ne rien faire ou de permettre le remplacement
                // Pour l'instant, on ne fait rien
                positionElement.style.boxShadow = '0 0 0 3px var(--accent)';
                currentPosition = positionElement;
                currentTargetPosition = positionType;
                return;
            }
            
            positionElement.style.boxShadow = '0 0 0 3px var(--accent)';
            currentPosition = positionElement;
            currentTargetPosition = positionType;
        }

        // Mise à jour du résumé de l'équipe
        function updateSummary() {
            document.getElementById('playersCount').textContent = `${selectedPlayers.length}/15`;
            document.getElementById('remainingBudget').textContent = `${remainingBudget.toFixed(1)}M MAD`;
            document.getElementById('budgetAmount').textContent = `${remainingBudget.toFixed(1)}M MAD`;
            
            // Calculer la moyenne d'âge
            if (selectedPlayers.length > 0) {
                const totalAge = selectedPlayers.reduce((sum, p) => sum + (p.player.age || 0), 0);
                const averageAge = totalAge / selectedPlayers.length;
                document.getElementById('averageAge').textContent = averageAge.toFixed(1);
            } else {
                document.getElementById('averageAge').textContent = "0.0";
            }
            
            // Compter les clubs différents
            const clubs = [...new Set(selectedPlayers.map(p => p.player.club))];
            document.getElementById('clubsCount').textContent = clubs.length;
        }

        // Suppression d'un joueur
        function removePlayer(index) {
            // Trouver le joueur à supprimer
            const playerIndex = selectedPlayers.findIndex(p => p.index === index);
            if (playerIndex !== -1) {
                const removedPlayer = selectedPlayers[playerIndex];
                
                // Rembourser le prix du joueur
                remainingBudget += removedPlayer.player.price;
                
                // Supprimer le joueur du tableau
                selectedPlayers.splice(playerIndex, 1);
                
                // Mettre à jour l'affichage
                if (index < 11) {
                    // Joueur titulaire
                    const positions = document.querySelectorAll('.position');
                    const position = positions[index];
                    if (position) {
                        position.classList.remove('occupied');
                        const positionType = position.dataset.position;
                        let icon, label;
                        switch(positionType) {
                            case 'GK': icon = 'hand-paper'; label = 'Gardien'; break;
                            case 'DEF': icon = 'shield-alt'; label = 'Défenseur'; break;
                            case 'MID': icon = 'running'; label = 'Milieu'; break;
                            case 'ATT': icon = 'futbol'; label = 'Attaquant'; break;
                        }
                        position.innerHTML = `
                            <div class="position-icon">
                                <i class="fas fa-${icon}"></i>
                            </div>
                            <div class="position-label">${label}</div>
                        `;
                        position.style.boxShadow = 'none';
                        // Ré-attacher l'écouteur d'événement
                        position.addEventListener('click', function() {
                            handlePositionClick(this, positionType);
                        });
                    }
                } else {
                    // Remplaçant
                    const substituteIndex = index - 11;
                    const substitutes = document.querySelectorAll('.substitute-slot');
                    const substitute = substitutes[substituteIndex];
                    if (substitute) {
                        substitute.classList.remove('occupied');
                        const positionType = substitute.dataset.position;
                        let icon, label;
                        switch(positionType) {
                            case 'GK': icon = 'hand-paper'; label = 'Gardien'; break;
                            case 'DEF': icon = 'shield-alt'; label = 'Défenseur'; break;
                            case 'MID': icon = 'running'; label = 'Milieu'; break;
                            case 'ATT': icon = 'futbol'; label = 'Attaquant'; break;
                            default: icon = 'user'; label = 'Remplaçant';
                        }
                        substitute.innerHTML = `
                            <div class="substitute-icon">
                                <i class="fas fa-${icon}"></i>
                            </div>
                            <div>Remplaçant ${substituteIndex + 1}</div>
                        `;
                        substitute.style.boxShadow = 'none';
                    }
                }
                
                // Mise à jour du résumé
                updateSummary();
                
                // Re-filtrer la liste des joueurs pour réactiver le bouton du joueur supprimé
                filterPlayers();
            }
        }

        // Validation de l'équipe
        function validateTeam() {
            // Vérification du nombre total de joueurs
            if (selectedPlayers.length !== 15) {
                alert(`Vous devez sélectionner 15 joueurs. Actuellement: ${selectedPlayers.length}`);
                return;
            }

            // Vérification de la composition
            const gkCount = selectedPlayers.filter(p => p.player.position === 'GK').length;
            const defCount = selectedPlayers.filter(p => p.player.position === 'DEF').length;
            const midCount = selectedPlayers.filter(p => p.player.position === 'MID').length;
            const attCount = selectedPlayers.filter(p => p.player.position === 'ATT').length;
            
            const [def, mid, att] = currentFormation.split('-').map(Number);
            
            // Compter les remplaçants (indices 11-14)
            const substitutes = selectedPlayers.filter(p => p.index >= 11 && p.index <= 14);
            const subGkCount = substitutes.filter(p => p.player.position === 'GK').length;
            const subDefCount = substitutes.filter(p => p.player.position === 'DEF').length;
            const subMidCount = substitutes.filter(p => p.player.position === 'MID').length;
            const subAttCount = substitutes.filter(p => p.player.position === 'ATT').length;

            // Vérifier que les titulaires correspondent à la formation
            if ((gkCount - subGkCount) !== 1 || 
                (defCount - subDefCount) !== def || 
                (midCount - subMidCount) !== mid || 
                (attCount - subAttCount) !== att) {
                alert('La composition de vos joueurs titulaires ne correspond pas à la formation sélectionnée!');
                return;
            }

            // Vérifier qu'il y a exactement 4 remplaçants
            if (substitutes.length !== 4) {
                alert('Vous devez avoir exactement 4 remplaçants!');
                return;
            }

            // Vérification des clubs
            const clubs = {};
            selectedPlayers.forEach(player => {
                if (!clubs[player.player.club]) {
                    clubs[player.player.club] = 0;
                }
                clubs[player.player.club]++;
            });
            const overLimitClubs = Object.keys(clubs).filter(club => clubs[club] > 4);
            if (overLimitClubs.length > 0) {
                alert(`Vous ne pouvez pas avoir plus de 4 joueurs du même club. Clubs concernés: ${overLimitClubs.join(', ')}`);
                return;
            }

            // Si tout est bon
            alert('Votre équipe est valide! Sauvegarde en cours...');
            // Ici, vous pouvez envoyer les données au serveur ou les sauvegarder dans localStorage
            // Exemple de sauvegarde locale:
            // const teamDataToSave = {
            //     userId: currentUser.sub, // Utiliser l'ID Google de l'utilisateur
            //     selectedPlayers: selectedPlayers,
            //     remainingBudget: remainingBudget,
            //     currentFormation: currentFormation,
            //     timestamp: new Date().toISOString()
            // };
            // localStorage.setItem('fantasyTeamData', JSON.stringify(teamDataToSave));
            // console.log("Équipe sauvegardée localement:", teamDataToSave);
        }
    </script>
</body>
</html>
