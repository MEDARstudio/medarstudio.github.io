<!DOCTYPE html>
<html lang="fr">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Permissions-Policy" content="identity-credentials-get=*">
    <title>Sélection d'Équipe - Fantasy Botola Pro Inwi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    :root {
        --primary: #6A0DAD;
        --secondary: #9370DB;
        --accent: #BA55D3;
        --light: #f8f9fa;
        --dark: #212529;
        --gray: #6c757d;
        --dark-bg: #1a0033;
        --card-bg: rgba(106, 13, 173, 0.1);
        --hover-bg: rgba(186, 85, 211, 0.15);
        --success: #4CAF50;
        --danger: #F44336;
    }
    body {
        background: linear-gradient(135deg, var(--dark-bg) 0%, #2d0052 100%);
        color: var(--light);
    }
    /* Header */
    header {
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        padding: 1rem 5%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
    }
     .logo a {
        display: flex;
        align-items: center;
        gap: 15px;
        text-decoration: none;
        color: inherit;
    }
    .logo-icon {
        background: var(--primary);
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    .logo-text {
        font-size: 1.8rem;
        font-weight: 700;
    }
    .logo-text span {
        color: var(--accent);
    }
    .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .user-profile {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid var(--accent);
    }
    .user-name {
        font-weight: 600;
    }
    .budget-display {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50px;
        padding: 0.5rem 1.5rem;
        font-weight: 600;
    }
    .budget-amount {
        color: var(--accent);
    }
     .logout-btn {
        background: none;
        border: 1px solid var(--accent);
        color: var(--accent);
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        cursor: pointer;
    }
    /* Main Content */
    .main-container {
        max-width: 1400px;
        margin: 2rem auto;
        padding: 0 2rem;
    }
    .page-title {
        text-align: center;
        font-size: 2.5rem;
        margin-bottom: 1rem;
        color: var(--accent);
    }
    .page-subtitle {
        text-align: center;
        font-size: 1.2rem;
        margin-bottom: 2rem;
        color: #e0e0e0;
    }
    /* Chips Section */
    .chips-section {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid rgba(186, 85, 211, 0.3);
    }
    .chips-title {
        font-size: 1.5rem;
        margin-bottom: 1rem;
        color: var(--accent);
    }
    .chips-options {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }
    .chip-button {
        background: var(--card-bg);
        border: 1px solid var(--secondary);
        color: var(--light);
        padding: 0.8rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
    }
    .chip-button:hover:not(:disabled) {
        background: var(--hover-bg);
    }
    .chip-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    /* Pitch */
    .content-container {
        display: flex;
        gap: 2rem;
    }
    .pitch-container {
        flex: 1;
        background: linear-gradient(to right, #2e7d32, #1b5e20);
        border: 4px solid #fff;
        border-radius: 10px;
        min-height: 700px;
        padding: 20px;
    }
    .pitch-positions {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .position-row {
        display: flex;
        justify-content: space-around;
    }
    .position {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        border: 2px dashed rgba(255, 255, 255, 0.5);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
    }
    .position.occupied {
        background: rgba(106, 13, 173, 0.7);
        border: 2px solid var(--accent);
    }
    .position-label {
        font-size: 0.8rem;
        font-weight: 600;
    }
    .captain-badge {
        position: absolute;
        top: 0;
        right: 0;
        background-color: var(--accent);
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
    }
    /* Player List */
    .players-section {
        flex: 1;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 15px;
        padding: 1.5rem;
    }
    .players-list {
        overflow-y: auto;
        max-height: 600px;
    }
    .player-card {
        background: var(--card-bg);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .player-card.selected { background: var(--hover-bg); }
    .player-info { flex: 1; }
    .player-name { font-weight: 600; }
    .player-details {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
    }
    .last-match-points {
        margin-top: 4px;
        font-size: 0.8rem;
        color: var(--secondary);
    }
    .player-price { font-weight: 700; color: var(--accent); }
    .select-player-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
    }
    .select-player-btn:disabled { background: var(--gray); cursor: not-allowed; }
    .remove-player-btn {
        background: var(--danger);
        color: white;
        border: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
        position: absolute;
        top: -5px;
        left: -5px;
    }
    /* Validation */
    .validation-section {
        text-align: right;
        margin-top: 2rem;
    }
    .validate-button {
        background: var(--primary);
        color: white;
        border: none;
        padding: 1rem 2.5rem;
        font-size: 1.2rem;
        font-weight: 600;
        border-radius: 50px;
        cursor: pointer;
    }
    .validate-button:disabled { background: var(--gray); cursor: not-allowed; }

    /* Captaincy Modal */
    .modal-overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1001;
    }
    .modal-content {
        background: var(--dark-bg);
        padding: 2rem;
        border-radius: 10px;
        display: flex;
        gap: 1rem;
    }
    .modal-button {
        padding: 0.8rem 1.5rem;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
    }
</style>
</head>
<body>
    <header>
        <div class="logo">
             <a href="accueil.html">
                <div class="logo-icon"><i class="fas fa-futbol"></i></div>
                <div class="logo-text">Fantasy <span>Botola Pro</span> Inwi</div>
            </a>
        </div>
        <div class="user-info">
            <!-- Populated by JS -->
        </div>
    </header>

    <div class="main-container">
        <h1 class="page-title">Mon Équipe</h1>
        <p class="page-subtitle" id="pageSubtitle">Sélectionnez 15 joueurs pour votre équipe initiale.</p>
        
        <section class="chips-section">
            <h2 class="chips-title"><i class="fas fa-magic"></i> Chips Disponibles</h2>
            <div class="chips-options">
                <button class="chip-button" id="wildcardBtn">Wildcard</button>
                <button class="chip-button" id="freeHitBtn">Free Hit (-5 pts)</button>
                <button class="chip-button" id="tripleCaptainBtn">Triple Captain</button>
                <button class="chip-button" id="benchBoostBtn">Bench Boost</button>
            </div>
        </section>

        <!-- Main content area -->
        <div class="content-container">
            <div class="pitch-container">
                <div class="pitch-positions">
                    <div class="position-row" id="attack-row"></div>
                    <div class="position-row" id="midfield-row"></div>
                    <div class="position-row" id="defense-row"></div>
                    <div class="position-row" id="goalkeeper-row"></div>
                </div>
            </div>
            <section class="players-section" id="playersSection">
                 <div class="filters"> <!-- Simplified filters -->
                    <select class="filter-select" id="positionFilter"></select>
                    <input type="text" class="search-box" id="searchBox" placeholder="Rechercher...">
                </div>
                <div class="players-list" id="playersList"></div>
            </section>
        </div>
        
        <div class="substitutes-section">
             <div class="substitutes-grid" id="substitutesGrid"></div>
        </div>

        <div class="validation-section">
            <button class="validate-button" id="validateBtn">Valider l'Équipe</button>
        </div>
    </div>
    
    <!-- Captaincy Modal -->
    <div class="modal-overlay" id="captaincyModal">
        <div class="modal-content">
            <button class="modal-button" id="makeCaptainBtn">Mettre Capitaine (C)</button>
            <button class="modal-button" id="makeViceCaptainBtn">Mettre Vice-Capitaine (VC)</button>
            <button class="modal-button" id="cancelCaptaincyBtn">Annuler</button>
        </div>
    </div>

<script>
// --- Global State ---
let playersData = [];
let team = {
    players: [], // array of player objects
    captainId: null,
    viceCaptainId: null,
    formation: '4-4-2',
};
let isEditMode = false;
let freeTransfers = 1;
let transfersMade = 0;
let activeSlot = null; // DOM element for the slot being modified

// --- Main Initialization ---
document.addEventListener('DOMContentLoaded', async () => {
    const userData = localStorage.getItem('fantasyUser');
    if (!userData) {
        window.location.href = 'index.html';
        return;
    }
    displayUserProfile(JSON.parse(userData));

    await loadPlayersFromCSV();
    loadTeamFromStorage();

    if (team.players.length === 15) {
        // Team exists, set to view mode
        isEditMode = false;
        document.getElementById('pageSubtitle').textContent = "Voici votre équipe actuelle. Cliquez sur 'Faire des transferts' pour la modifier.";
        document.getElementById('validateBtn').textContent = "Faire des transferts";
        document.getElementById('playersSection').style.display = 'none';
    } else {
        // New user, set to edit/setup mode
        isEditMode = true;
    }
    
    setupEventListeners();
    renderPitch();
    updateSummary();
});

// --- Data Loading & Saving ---
async function loadPlayersFromCSV() {
    try {
        const response = await fetch('liste_des_joueurs.csv');
        const csvText = await response.text();
        const results = Papa.parse(csvText, {
            header: true, skipEmptyLines: true,
            transform: (v, h) => (['id', 'price', 'points', 'performance', 'last_match_points'].includes(h)) ? parseFloat(v) || 0 : v,
        });
        playersData = results.data;
    } catch (error) {
        console.error("Error loading players CSV:", error);
    }
}

function loadTeamFromStorage() {
    const savedTeam = localStorage.getItem('fantasyTeam');
    if (savedTeam) {
        const parsedTeam = JSON.parse(savedTeam);
        // Convert player IDs back to full player objects
        parsedTeam.players = parsedTeam.playerIds.map(id => playersData.find(p => p.id === id)).filter(Boolean);
        delete parsedTeam.playerIds;
        team = parsedTeam;
    }
}

function saveTeamToStorage() {
    // Save only player IDs to save space
    const teamToSave = {
        ...team,
        playerIds: team.players.map(p => p.id)
    };
    delete teamToSave.players;
    localStorage.setItem('fantasyTeam', JSON.stringify(teamToSave));
}

// --- UI Rendering ---
function displayUserProfile(user) {
    const userInfoContainer = document.querySelector('.user-info');
    if (userInfoContainer) {
        userInfoContainer.innerHTML = `
            <div class="user-profile">
                <img src="${user.picture}" alt="${user.name}" class="user-avatar">
                <span class="user-name">${user.username}</span>
            </div>
            <div class="budget-display">Budget: <span class="budget-amount">100.0M</span></div>
            <button class="logout-btn" id="logoutBtn">Déconnexion</button>
        `;
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('fantasyUser');
            localStorage.removeItem('fantasyTeam');
            window.location.href = 'index.html';
        });
    }
}

function renderPitch() {
    const [def, mid, att] = team.formation.split('-').map(Number);
    const positions = [
        ...Array(att).fill('ATT'),
        ...Array(mid).fill('MID'),
        ...Array(def).fill('DEF'),
        'GK'
    ];
    
    // Simple rendering, assumes first players in list match order
    const starters = team.players.slice(0, 11);
    const subs = team.players.slice(11);
    
    const pitchEl = document.querySelector('.pitch-positions');
    pitchEl.innerHTML = ''; // Clear pitch
    
    let playerIndex = 0;
    ['attack-row', 'midfield-row', 'defense-row', 'goalkeeper-row'].forEach(rowId => {
        const rowEl = document.createElement('div');
        rowEl.className = 'position-row';
        const positionType = rowId.split('-')[0].toUpperCase().substring(0, 3);
        const count = positionType === 'ATT' ? att : positionType === 'MID' ? mid : positionType === 'DEF' ? def : 1;

        for (let i = 0; i < count; i++) {
            const player = starters.find(p => p.position === positionType && !p.isPlaced) || null;
            if(player) player.isPlaced = true; // Mark as placed
            const slot = createSlotElement('position', player);
            rowEl.appendChild(slot);
        }
        pitchEl.appendChild(rowEl);
    });
    starters.forEach(p => delete p.isPlaced); // Clean up temp property

    const subsGrid = document.getElementById('substitutesGrid');
    subsGrid.innerHTML = '';
    for(let i=0; i < 4; i++) {
        const slot = createSlotElement('substitute-slot', subs[i] || null);
        subsGrid.appendChild(slot);
    }
}

function createSlotElement(className, player) {
    const slot = document.createElement('div');
    slot.className = className + (player ? ' occupied' : '');
    if(player) slot.dataset.playerId = player.id;

    if (player) {
        slot.innerHTML = `
            <div>${player.name.split(' ')[0]}</div>
            <div class="position-label">${player.price.toFixed(1)}M</div>
            ${team.captainId === player.id ? '<div class="captain-badge">C</div>' : ''}
            ${team.viceCaptainId === player.id ? '<div class="captain-badge" style="background: var(--gray);">V</div>' : ''}
        `;
    } else {
        slot.innerHTML = `<div>+</div>`;
    }

    slot.addEventListener('click', () => {
        if (isEditMode) {
            // Handle player replacement
        } else if (player) {
            activeSlot = slot;
            document.getElementById('captaincyModal').style.display = 'flex';
        }
    });
    return slot;
}

function updateSummary() {
    const usedBudget = team.players.reduce((sum, p) => sum + p.price, 0);
    const remainingBudget = 100.0 - usedBudget;
    document.querySelector('.budget-amount').textContent = `${remainingBudget.toFixed(1)}M`;
    document.getElementById('validateBtn').disabled = team.players.length !== 15 || remainingBudget < 0;
}

// --- Event Listeners Setup ---
function setupEventListeners() {
    const validateBtn = document.getElementById('validateBtn');
    validateBtn.addEventListener('click', () => {
        if (!isEditMode) { // Currently in "View Mode" -> switch to "Edit Mode"
            isEditMode = true;
            validateBtn.textContent = `Confirmer Transferts (-${Math.max(0, transfersMade - freeTransfers) * 4}pts)`;
            document.getElementById('playersSection').style.display = 'block';
            document.getElementById('pageSubtitle').textContent = "Mode transfert activé. Vous avez 1 transfert gratuit.";
            renderPlayerList();
        } else { // Currently in "Edit Mode" -> Validate/Save
            if (team.players.length !== 15) return alert("Vous devez avoir 15 joueurs.");
            saveTeamToStorage();
            isEditMode = false;
            transfersMade = 0; // Reset for next time
            validateBtn.textContent = "Faire des transferts";
            document.getElementById('playersSection').style.display = 'none';
            alert("Équipe sauvegardée !");
        }
    });

    // Captaincy Modal
    const captaincyModal = document.getElementById('captaincyModal');
    document.getElementById('makeCaptainBtn').addEventListener('click', () => setCaptaincy(true));
    document.getElementById('makeViceCaptainBtn').addEventListener('click', () => setCaptaincy(false));
    document.getElementById('cancelCaptaincyBtn').addEventListener('click', () => captaincyModal.style.display = 'none');
}

function setCaptaincy(isCaptain) {
    const playerId = parseInt(activeSlot.dataset.playerId);
    if (isCaptain) {
        if (team.viceCaptainId === playerId) team.viceCaptainId = null; // Cannot be both
        team.captainId = playerId;
    } else {
        if (team.captainId === playerId) team.captainId = null; // Cannot be both
        team.viceCaptainId = playerId;
    }
    document.getElementById('captaincyModal').style.display = 'none';
    saveTeamToStorage();
    renderPitch();
}

// Dummy function for player list rendering in edit mode
function renderPlayerList() {
    const listEl = document.getElementById('playersList');
    listEl.innerHTML = '';
    playersData.slice(0, 20).forEach(p => {
        const isSelected = team.players.some(pl => pl.id === p.id);
        listEl.innerHTML += `
            <div class="player-card ${isSelected ? 'selected' : ''}">
                <div class="player-info">
                    <div class="player-name">${p.name}</div>
                    <div class="player-details">${p.club} - ${p.position}</div>
                    <div class="last-match-points">Dernier Match: ${p.last_match_points} pts</div>
                </div>
                <div class="player-price">${p.price.toFixed(1)}M</div>
                <button class="select-player-btn" ${isSelected ? 'disabled' : ''}>Ajouter</button>
            </div>
        `;
    });
}

</script>
</body>
</html>
